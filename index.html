<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dictation Exercise Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input[type="text"].correct {
            border-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        input[type="text"].incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        /* Tab styles */
        .tab-btn {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-btn.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-3xl space-y-6">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI Dictation Exercise Generator</h1>
            <p class="text-gray-600 mt-2">Create and complete AI-powered dictation exercises.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button id="setup-tab-btn" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-lg text-gray-500 hover:text-blue-600 hover:border-blue-300">
                    Setup
                </button>
                <button id="exercise-tab-btn" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-lg text-gray-500 hover:text-blue-600 hover:border-blue-300" disabled>
                    Exercise
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Instructor Input Section (Setup Tab) -->
            <div id="setup-tab-content" class="space-y-4">
                <div>
                    <label for="cefr-level" class="block text-lg font-semibold text-gray-700">CEFR Difficulty Level</label>
                    <select id="cefr-level" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="A1">A1 (Beginner)</option>
                        <option value="A2">A2 (Elementary)</option>
                        <option value="B1" selected>B1 (Intermediate)</option>
                        <option value="B2">B2 (Upper-Intermediate)</option>
                        <option value="C1">C1 (Advanced)</option>
                    </select>
                </div>
                <div>
                    <label for="keywords" class="block text-lg font-semibold text-gray-700">Keywords & Phrases</label>
                    <textarea id="keywords" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., renewable energy, solar panels, sustainability, carbon footprint"></textarea>
                    <p class="text-sm text-gray-500">Separate words or phrases with a comma.</p>
                </div>
                <button id="generate-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform hover:scale-105 active:scale-100 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Generate Exercise
                </button>
            </div>

            <!-- Student Exercise Section (Exercise Tab) -->
            <div id="exercise-tab-content" class="hidden space-y-4 fade-in">
                <!-- Audio Player -->
                <div>
                    <p class="text-lg font-semibold mb-2 text-gray-700">Listen to the passage:</p>
                    <audio id="audio-player" controls class="w-full"></audio>
                </div>

                <!-- Dictation Passage with Blanks -->
                <div>
                    <p class="text-lg font-semibold mb-2 text-gray-700">Fill in the blanks:</p>
                    <div id="passage-container" class="text-lg leading-relaxed bg-gray-100 p-4 rounded-lg space-y-2">
                        <!-- The passage with input fields will be injected here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                    <button id="check-answers-btn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105 active:scale-100">
                        Check Answers
                    </button>
                     <button id="share-btn" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 active:scale-100">
                        Share Exercise
                    </button>
                    <button id="start-over-btn" class="w-full bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                        Start Over
                    </button>
                </div>
                
                 <!-- Results Display -->
                <div id="results-container" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg fade-in">
                    <p id="results-text" class="text-center font-medium text-blue-800"></p>
                </div>
                 <!-- Share Confirmation -->
                <div id="share-confirmation" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg fade-in">
                    <p class="text-center font-medium text-green-800">Shareable link copied to clipboard!</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loader-container" class="hidden flex-col items-center justify-center space-y-2 text-center py-10">
            <div class="loader"></div>
            <p class="text-gray-600 font-medium">Generating your dictation exercise...</p>
            <p class="text-sm text-gray-500">This may take a moment.</p>
        </div>
        
        <!-- Error Message Box -->
        <div id="error-box" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">
            <p id="error-message"></p>
        </div>

    </main>

    <script type="module">
        // --- DOM Element References ---
        const generateBtn = document.getElementById('generate-btn');
        const keywordsInput = document.getElementById('keywords');
        const cefrLevelSelect = document.getElementById('cefr-level');
        const loaderContainer = document.getElementById('loader-container');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const passageContainer = document.getElementById('passage-container');
        const audioPlayer = document.getElementById('audio-player');
        const checkAnswersBtn = document.getElementById('check-answers-btn');
        const startOverBtn = document.getElementById('start-over-btn');
        const shareBtn = document.getElementById('share-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsText = document.getElementById('results-text');
        const shareConfirmation = document.getElementById('share-confirmation');
        
        // Tab elements
        const setupTabBtn = document.getElementById('setup-tab-btn');
        const exerciseTabBtn = document.getElementById('exercise-tab-btn');
        const setupTabContent = document.getElementById('setup-tab-content');
        const exerciseTabContent = document.getElementById('exercise-tab-content');
        const tabContentContainer = document.getElementById('tab-content');

        let currentExercise = {
            passage: '',
            keywords: [],
            cefrLevel: ''
        };

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDkeKjf4XuVU6bTdDw5eMArO6XFTXH1V1o",
            authDomain: "listening-4a199.firebaseapp.com",
            projectId: "listening-4a199",
            storageBucket: "listening-4a199.appspot.com",
            messagingSenderId: "44749070449",
            appId: "1:44749070449:web:8a347a0c4b2be232b9fbd0",
            measurementId: "G-F7XPVVPEXR"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- API Configuration ---
        const API_KEY = "AIzaSyAQd6t3l6Dg9_Vc5LdMEcbnRVE0Cr5ndnY"; // This will be automatically handled by the environment.
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        
        async function fetchWithBackoff(url, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error?.message || 'Unknown error'}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    console.warn(`API call failed. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generatePassage(keywords, level) {
            const systemPrompt = `You are an English teacher... Generate a short, clear paragraph for an English learner at the ${level} CEFR level... The passage must incorporate: "${keywords.join('", "')}". Do not use markdown.`;
            const userQuery = `Generate a single paragraph at CEFR level ${level} that includes: "${keywords.join('", "')}".`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { temperature: 0.7, maxOutputTokens: 500 },
                safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }]
            };
            const result = await fetchWithBackoff(TEXT_API_URL, payload);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Failed to generate a valid passage.");
            return text.trim();
        }

        async function generateAudio(text) {
            const payload = {
                contents: [{ parts: [{ text: `Read this passage clearly: ${text}` }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                model: "gemini-2.5-flash-preview-tts",
                safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }]
            };
            const result = await fetchWithBackoff(TTS_API_URL, payload);
            const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            if (!audioData) throw new Error("Failed to generate valid audio data.");
            return audioData;
        }
        
        // --- Firestore Functions ---
        async function saveExercise(exerciseData) {
            const docRef = await db.collection("exercises").add(exerciseData);
            return docRef.id;
        }

        async function loadExercise(id) {
            const doc = await db.collection("exercises").doc(id).get();
            if (doc.exists) {
                return doc.data();
            } else {
                throw new Error("Exercise not found.");
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16, blockAlign = (numChannels * bitsPerSample) / 8, byteRate = sampleRate * blockAlign, dataSize = pcmData.length * (bitsPerSample / 8), buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer);
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); writeString(view, 36, 'data'); view.setUint32(40, dataSize, true);
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }

        function createDictationUI(passage, keywords) {
            const sortedKeywords = [...keywords].sort((a, b) => b.length - a.length);
            let passageHTML = passage;
            const regex = new RegExp(`(${sortedKeywords.map(kw => kw.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})`, 'gi');
            passageHTML = passageHTML.replace(regex, (match) => {
                const originalKw = keywords.find(kw => kw.toLowerCase() === match.toLowerCase());
                const inputWidth = Math.max(originalKw.length * 10, 80);
                return `<input type="text" data-answer="${originalKw}" class="dictation-blank border-b-2 border-gray-400 focus:border-blue-500 outline-none bg-transparent text-center transition mx-1" style="width: ${inputWidth}px;">`;
            });
            passageContainer.innerHTML = `<p>${passageHTML}</p>`;
        }

        function switchTab(tabName) {
            const isSetup = tabName === 'setup';
            setupTabBtn.classList.toggle('active', isSetup);
            exerciseTabBtn.classList.toggle('active', !isSetup);
            setupTabContent.classList.toggle('hidden', !isSetup);
            exerciseTabContent.classList.toggle('hidden', isSetup);
        }
        
        function setLoadingState(isLoading) {
            tabContentContainer.classList.toggle('hidden', isLoading);
            loaderContainer.classList.toggle('hidden', !isLoading);
            errorBox.classList.add('hidden');
            generateBtn.disabled = isLoading;
        }
        
        async function handleGenerateClick() {
            const keywordsText = keywordsInput.value.trim();
            if (!keywordsText) {
                showError("Please enter keywords.");
                return;
            }
            const keywords = keywordsText.split(',').map(kw => kw.trim()).filter(Boolean);
            if (keywords.length === 0) {
                showError("Please enter valid keywords.");
                return;
            }
            const selectedLevel = cefrLevelSelect.value;
            setLoadingState(true);
            try {
                const passage = await generatePassage(keywords, selectedLevel);
                const cleanedPassage = passage.replace(/\*/g, '');
                await setupExercise(cleanedPassage, keywords, selectedLevel);
            } catch (error) {
                console.error("Error during generation:", error);
                showError(error.message || "An unknown error occurred.");
                setLoadingState(false);
            }
        }

        async function setupExercise(passage, keywords, cefrLevel) {
            currentExercise = { passage, keywords, cefrLevel };
            const audioData = await generateAudio(passage);
            createDictationUI(passage, keywords);
            const pcmBuffer = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmBuffer);
            const wavBlob = pcmToWav(pcm16, 24000);
            const audioUrl = URL.createObjectURL(wavBlob);
            audioPlayer.src = audioUrl;
            setLoadingState(false);
            exerciseTabBtn.disabled = false;
            switchTab('exercise');
        }

        function handleCheckAnswers() {
            const inputs = passageContainer.querySelectorAll('.dictation-blank');
            let correctCount = 0;
            inputs.forEach(input => {
                if (input.value.trim().toLowerCase() === input.dataset.answer.toLowerCase()) {
                    input.classList.remove('incorrect'); input.classList.add('correct'); correctCount++;
                } else {
                    input.classList.remove('correct'); input.classList.add('incorrect');
                }
            });
            resultsText.textContent = `You got ${correctCount} out of ${inputs.length} correct!`;
            resultsContainer.classList.remove('hidden');
        }
        
        async function handleShareClick() {
            try {
                const exerciseId = await saveExercise(currentExercise);
                const baseUrl = window.location.href.split('?')[0]; // Get URL without existing query params
                const shareUrl = `${baseUrl}?exercise=${exerciseId}`;
                
                // Fallback for copying to clipboard
                const textArea = document.createElement("textarea");
                textArea.value = shareUrl;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);

                shareConfirmation.classList.remove('hidden');
                setTimeout(() => shareConfirmation.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error sharing exercise:", error);
                showError("Could not save or copy the exercise link. Please try again.");
            }
        }

        function handleStartOver() {
            switchTab('setup');
            keywordsInput.value = '';
            passageContainer.innerHTML = '';
            audioPlayer.src = '';
            currentExercise = {};
            exerciseTabBtn.disabled = true;
            exerciseTabBtn.classList.remove('active');
            resultsContainer.classList.add('hidden');
            shareConfirmation.classList.add('hidden');
            cefrLevelSelect.value = 'B1';
            window.history.pushState({}, '', window.location.pathname);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            tabContentContainer.classList.add('hidden');
        }

        async function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const exerciseId = params.get('exercise');
            if (exerciseId) {
                setLoadingState(true);
                try {
                    const exerciseData = await loadExercise(exerciseId);
                    await setupExercise(exerciseData.passage, exerciseData.keywords, exerciseData.cefrLevel);
                } catch (error) {
                    console.error("Error loading from URL:", error);
                    showError("Could not load the shared exercise. It may have been deleted.");
                    setLoadingState(false);
                }
            }
        }

        // --- Attach Event Listeners ---
        window.addEventListener('load', loadFromUrl);
        generateBtn.addEventListener('click', handleGenerateClick);
        checkAnswersBtn.addEventListener('click', handleCheckAnswers);
        shareBtn.addEventListener('click', handleShareClick);
        startOverBtn.addEventListener('click', handleStartOver);
        setupTabBtn.addEventListener('click', () => switchTab('setup'));
        exerciseTabBtn.addEventListener('click', () => switchTab('exercise'));
    </script>
</body>
</html>
